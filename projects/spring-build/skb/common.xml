<?xml version="1.0" encoding="UTF-8"?>
<project name="skb-common" xmlns:ivy="antlib:org.apache.ivy.ant">

	<target name="antlr.clean">
		<echo message="Removing ANTLR autogenerated files"/>
		<delete verbose="true">
			<fileset dir="${main.java.dir}"
				includes="**/grammars/*.java,**/grammars/*.tokens" />
		</delete>
	</target>

	<target name="antlr" description="Generates java classes based on grammar"/>

	<macrodef name="antlr-run">
		<attribute name="verbose" default="true"/>
		<attribute name="output.dir"/>
		<attribute name="grammar.file"/>
		<sequential>
			<antlr:ant-antlr3 xmlns:antlr="antlib:org/apache/tools/ant/antlr"
				verbose="@{verbose}"
				outputdirectory="@{output.dir}"
				target="@{grammar.file}"/>
		</sequential>
	</macrodef>

	<target name="constants.init" depends="ivy.init">
		<echo message="Removing GenConstants autogenerated files"/>
		<delete verbose="true">
			<fileset dir="${main.java.dir}" includes="**/proto/*Constants.java" />
		</delete>
		<echo message="Resolving GenerateConstantsTask"/>
                <ivy:cachepath resolveId="skb.ant.path" pathid="skb.ant.path"
			organisation="skb" module="skb.ant" revision="${skb.ant}"
			conf="runtime" type="jar" inline="true" log="download-only" />
		<taskdef name="skb-genconst"
			classname="org.skb.ant.tribe.GenerateConstantsTask"
			classpathref="skb.ant.path"/>
        </target>

	<target name="constants" description="Generates Constant classes based on grammar"/>

	<macrodef name="generate-constants">
		<attribute name="constants.type"/>
		<attribute name="pkg.name"/>
		<attribute name="class.name"/>
		<attribute name="str.template" default="/org/skb/ant/tribe/constants.stg" />
		<attribute name="json.file"/>
		<attribute name="dest.dir"/>
		<sequential>
			<skb-genconst type="@{constants.type}" pkgname="@{pkg.name}" stgurl="@{str.template}"
				jsonfile="@{json.file}"
				classname="@{class.name}"
				destdir="@{dest.dir}"
				destfile="@{class.name}.java"/>
		</sequential>
	</macrodef>

	<target name="prepare" description="Prepares an SKB project for building"/>

	<target name="add.anttask"
		depends="version,clean,jar"
		description="Add AntTask jar to ANT lib">
		<property name="ant.lib" value="${env.ANT_HOME}/lib"/>
		<delete file="${ant.lib}/${ant.project.name}.jar" verbose="true" />
		<copy file="${jar.output.file}" todir="${ant.lib}" failonerror="true" />
		<echo message="Updated ${ant.project.name}.jar (AntTask) in the ${ant.lib} folder"/>	
	</target>

  <target name="clean-gen" depends="antlr.clean">
		<echo message="Removing GenConstants autogenerated files"/>
		<delete verbose="true">
			<fileset dir="${main.java.dir}" includes="**/proto/*Constants.java" />
		</delete>
  </target>

</project>
